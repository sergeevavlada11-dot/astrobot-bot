import os
import logging
import sqlite3
from datetime import datetime

from aiogram import Bot, Dispatcher, types
from aiogram.types import ReplyKeyboardMarkup, KeyboardButton, InlineKeyboardMarkup, InlineKeyboardButton
from aiogram.utils.executor import start_webhook
from openai import OpenAI, OpenAIError

# ---------------------------------
# Logging
# ---------------------------------
logging.basicConfig(level=logging.INFO)
log = logging.getLogger("astrobot-final")

# ---------------------------------
# Env
# ---------------------------------
TELEGRAM_TOKEN = os.getenv("TELEGRAM_TOKEN")
OPENAI_API_KEY = os.getenv("OPENAI_API_KEY")
WEBHOOK_HOST = os.getenv("WEBHOOK_HOST")  # e.g. https://astrobot-xxx.onrender.com
WEBHOOK_PATH = "/"
WEBHOOK_URL = WEBHOOK_HOST
UNLOCK_CODE = os.getenv("UNLOCK_CODE", "ASTROVIP")
DB_PATH = os.getenv("DB_PATH", "astrobot.sqlite3")
PAY_URL = os.getenv("PAY_URL", "https://pay.example.com")

WEBAPP_HOST = "0.0.0.0"
WEBAPP_PORT = int(os.getenv("PORT", 10000))

if not TELEGRAM_TOKEN or not OPENAI_API_KEY or not WEBHOOK_HOST:
    raise RuntimeError("Set TELEGRAM_TOKEN, OPENAI_API_KEY, WEBHOOK_HOST")

# ---------------------------------
# Init
# ---------------------------------
bot = Bot(token=TELEGRAM_TOKEN, parse_mode=types.ParseMode.HTML)
dp = Dispatcher(bot)
client = OpenAI(api_key=OPENAI_API_KEY)

# ---------------------------------
# DB helpers
# ---------------------------------
def db_init():
    with sqlite3.connect(DB_PATH) as con:
        con.execute("""
            CREATE TABLE IF NOT EXISTS users (
                user_id INTEGER PRIMARY KEY,
                paid INTEGER DEFAULT 0,
                free_used INTEGER DEFAULT 0,
                city TEXT,
                birth_date TEXT,
                birth_time TEXT,
                created_at TEXT
            );
        """)
        con.execute("""
            CREATE TABLE IF NOT EXISTS readings (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                user_id INTEGER,
                sphere TEXT,
                subtopic TEXT,
                prompt TEXT,
                answer TEXT,
                created_at TEXT
            );
        """)
        con.commit()

def get_user(uid: int):
    with sqlite3.connect(DB_PATH) as con:
        cur = con.execute(
            "SELECT user_id, paid, free_used, city, birth_date, birth_time FROM users WHERE user_id=?",
            (uid,)
        )
        row = cur.fetchone()
        if not row:
            return None
        return {
            "user_id": row[0],
            "paid": bool(row[1]),
            "free_used": bool(row[2]),
            "city": row[3],
            "birth_date": row[4],
            "birth_time": row[5],
        }

def ensure_user(uid: int):
    u = get_user(uid)
    if u:
        return u
    with sqlite3.connect(DB_PATH) as con:
        con.execute(
            "INSERT OR IGNORE INTO users (user_id, created_at) VALUES (?, ?)",
            (uid, datetime.utcnow().isoformat())
        )
        con.commit()
    return get_user(uid)

def update_user(uid: int, **fields):
    if not fields:
        return
    cols = ",".join([f"{k}=?" for k in fields.keys()])
    vals = list(fields.values()) + [uid]
    with sqlite3.connect(DB_PATH) as con:
        con.execute(f"UPDATE users SET {cols} WHERE user_id=?", vals)
        con.commit()

def save_reading(uid: int, sphere: str, sub: str, prompt: str, answer: str):
    with sqlite3.connect(DB_PATH) as con:
        con.execute(
            "INSERT INTO readings (user_id, sphere, subtopic, prompt, answer, created_at) VALUES (?, ?, ?, ?, ?, ?)",
            (uid, sphere, sub, prompt, answer, datetime.utcnow().isoformat())
        )
        con.commit()

def delete_history(uid: int):
    with sqlite3.connect(DB_PATH) as con:
        con.execute("DELETE FROM readings WHERE user_id=?", (uid,))
        con.commit()

# ---------------------------------
# UI
# ---------------------------------
sphere_kb = ReplyKeyboardMarkup(
    keyboard=[
        [KeyboardButton("üß¨ –õ–∏—á–Ω–æ—Å—Ç—å"), KeyboardButton("üí∞ –î–µ–Ω—å–≥–∏")],
        [KeyboardButton("üíº –ö–∞—Ä—å–µ—Ä–∞"), KeyboardButton("‚ù§Ô∏è –û—Ç–Ω–æ—à–µ–Ω–∏—è")],
        [KeyboardButton("üåü –ü—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ")]
    ],
    resize_keyboard=True
)

sub_kb = ReplyKeyboardMarkup(
    keyboard=[
        [KeyboardButton("üìñ –û–±—â–µ–µ –æ–ø–∏—Å–∞–Ω–∏–µ")],
        [KeyboardButton("üîÆ –ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞ 5 –ª–µ—Ç")],
        [KeyboardButton("ü™∑ –°–æ–≤–µ—Ç—ã –ø–æ –≥–∞—Ä–º–æ–Ω–∏–∑–∞—Ü–∏–∏")],
        [KeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –∫ —Å—Ñ–µ—Ä–∞–º")]
    ],
    resize_keyboard=True
)

help_kb = InlineKeyboardMarkup().add(
    InlineKeyboardButton(text="üí≥ –û—Ñ–æ—Ä–º–∏—Ç—å –¥–æ—Å—Ç—É–ø", url=PAY_URL)
)

# ---------------------------------
# State (in-memory)
# ---------------------------------
STATE_WAIT_CITY = "wait_city"
STATE_WAIT_DATE = "wait_date"
STATE_WAIT_TIME = "wait_time"
STATE_READY = "ready"

user_state = {}  # per-user ephemeral state

def set_state(uid, state): user_state[uid] = state
def get_state(uid): return user_state.get(uid)

def fmt_profile(u):
    return (
        f"üìç –ì–æ—Ä–æ–¥: {u.get('city','‚Äî')}\n"
        f"üìÖ –î–∞—Ç–∞: {u.get('birth_date','‚Äî')}\n"
        f"‚è∞ –í—Ä–µ–º—è: {u.get('birth_time','‚Äî')}"
    )

SPHERE_MAP = {
    "üß¨ –õ–∏—á–Ω–æ—Å—Ç—å": "–õ–∏—á–Ω–æ—Å—Ç—å (—Å–∏–ª—å–Ω—ã–µ/ —Å–ª–∞–±—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã, –æ–ø–∏—Å–∞–Ω–∏–µ —á–µ–ª–æ–≤–µ–∫–∞)",
    "üí∞ –î–µ–Ω—å–≥–∏": "–î–µ–Ω—å–≥–∏ (–æ—Ç–Ω–æ—à–µ–Ω–∏–µ –∫ —Ñ–∏–Ω–∞–Ω—Å–∞–º –∏ –∑–æ–Ω—ã –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ –¥–æ—Ö–æ–¥–∞)",
    "üíº –ö–∞—Ä—å–µ—Ä–∞": "–ö–∞—Ä—å–µ—Ä–∞ (–≥–¥–µ –ª—É—á—à–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å—Å—è –∏ –Ω–∞ —á—Ç–æ –¥–µ–ª–∞—Ç—å –∞–∫—Ü–µ–Ω—Ç)",
    "‚ù§Ô∏è –û—Ç–Ω–æ—à–µ–Ω–∏—è": "–û—Ç–Ω–æ—à–µ–Ω–∏—è (–∫–∞–∫–æ–π —á–µ–ª–æ–≤–µ–∫ –≤ –æ—Ç–Ω–æ—à–µ–Ω–∏—è—Ö –∏ –≤–æ–∑–º–æ–∂–Ω–∞—è –¥–∏–Ω–∞–º–∏–∫–∞ –ø–∞—Ä—ã)",
    "üåü –ü—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ": "–ü—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ (–≤ —á–µ–º –ø—Ä–µ—É—Å–ø–µ—Ç—å –∏ —Å–∏–ª—å–Ω—ã–µ —Ç–∞–ª–∞–Ω—Ç—ã)"
}

SUB_MAP = {
    "üìñ –û–±—â–µ–µ –æ–ø–∏—Å–∞–Ω–∏–µ": "–æ–±—â–µ–µ –æ–ø–∏—Å–∞–Ω–∏–µ",
    "üîÆ –ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞ 5 –ª–µ—Ç": "–ø—Ä–æ–≥–Ω–æ–∑ –Ω–∞ 5 –ª–µ—Ç",
    "ü™∑ –°–æ–≤–µ—Ç—ã –ø–æ –≥–∞—Ä–º–æ–Ω–∏–∑–∞—Ü–∏–∏": "—Å–æ–≤–µ—Ç—ã –ø–æ –≥–∞—Ä–º–æ–Ω–∏–∑–∞—Ü–∏–∏"
}

main_topics = {
    "üß¨ –õ–∏—á–Ω–æ—Å—Ç—å": [
        "–û—Å–Ω–æ–≤–Ω—ã–µ –∞—Ä—Ö–µ—Ç–∏–ø—ã –ª–∏—á–Ω–æ—Å—Ç–∏",
        "–≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è –ø—Ä–∏—Ä–æ–¥–∞",
        "–°–∏–ª—å–Ω—ã–µ –∏ —Å–ª–∞–±—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã",
        "–ú–µ—Ö–∞–Ω–∏–∑–º—ã —Ä–æ—Å—Ç–∞",
        "–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏"
    ],
    "üí∞ –î–µ–Ω—å–≥–∏": [
        "–î–µ–Ω–µ–∂–Ω–æ–µ –º—ã—à–ª–µ–Ω–∏–µ",
        "–ò—Å—Ç–æ—á–Ω–∏–∫ –¥–æ—Ö–æ–¥–∞",
        "–°—Ç–∏–ª—å –æ–±—Ä–∞—â–µ–Ω–∏—è —Å —Ä–µ—Å—É—Ä—Å–∞–º–∏",
        "–ö–∞—Ä–º–∏—á–µ—Å–∫–∏–µ –∑–∞–¥–∞—á–∏ –¥–µ–Ω–µ–≥",
        "–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —à–∞–≥–∏"
    ],
    "üíº –ö–∞—Ä—å–µ—Ä–∞": [
        "–ü—Ä–∏—Ä–æ–¥–Ω—ã–π —Å—Ç–∏–ª—å —Ä–∞–±–æ—Ç—ã",
        "–°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã –≤ –∫–∞—Ä—å–µ—Ä–µ",
        "–û–ø—Ç–∏–º–∞–ª—å–Ω—ã–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è",
        "–ö–∞—Ä–º–∏—á–µ—Å–∫–∏–µ –∑–∞–¥–∞—á–∏ —Ä–∞–±–æ—Ç—ã",
        "–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Å–æ–≤–µ—Ç—ã"
    ],
    "‚ù§Ô∏è –û—Ç–Ω–æ—à–µ–Ω–∏—è": [
        "–≠–Ω–µ—Ä–≥–∏—è –ª—é–±–≤–∏",
        "–û–±—Ä–∞–∑ –∏–¥–µ–∞–ª—å–Ω–æ–≥–æ –ø–∞—Ä—Ç–Ω—ë—Ä–∞",
        "–°—Ü–µ–Ω–∞—Ä–∏–π –æ—Ç–Ω–æ—à–µ–Ω–∏–π",
        "–≠—Ç–∞–ø—ã —ç–≤–æ–ª—é—Ü–∏–∏ –ª—é–±–≤–∏",
        "–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏"
    ],
    "üåü –ü—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ": [
        "–ü—É—Ç—å –¥—É—à–∏",
        "–ì–ª–∞–≤–Ω—ã–µ –¥–∞—Ä—ã –∏ —Ç–∞–ª–∞–Ω—Ç—ã",
        "–£—Ä–æ–∫–∏ —Å—É–¥—å–±—ã",
        "–í–µ–∫—Ç–æ—Ä—ã —Ä–∞–∑–≤–∏—Ç–∏—è",
        "–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —à–∞–≥–∏"
    ]
}

# ---------------------------------
# Helpers
# ---------------------------------
def _valid_date(s: str) -> bool:
    try:
        datetime.strptime(s.strip(), "%d.%m.%Y")
        return True
    except Exception:
        return False

def _valid_time(s: str) -> bool:
    try:
        datetime.strptime(s.strip(), "%H:%M")
        return True
    except Exception:
        return False

def is_blocked(u) -> bool:
    return (not u.get("paid")) and u.get("free_used")

async def guard_access(message: types.Message, u) -> bool:
    if is_blocked(u):
        await message.answer(
            "üîí <b>–î–æ—Å—Ç—É–ø –æ–≥—Ä–∞–Ω–∏—á–µ–Ω</b>\n\n"
            "–¢—ã —É–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∞ –±–µ—Å–ø–ª–∞—Ç–Ω—É—é –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é.\n"
            "–ß—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å –≤—Å–µ —Ä–∞–∑–¥–µ–ª—ã ‚Äî –≤–≤–µ–¥–∏ <b>—Å–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–æ–¥</b> –¥–ª—è —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏."
        )
        return False
    return True

VALID_CODES = {
    "ASTRO-1F9A-2025",
    "ASTRO-2X4M-2025",
    "ASTRO-3L7P-2025",
    "ASTRO-4V2Q-2025",
    "ASTRO-5R8D-2025",
    "ASTRO-6H1Z-2025",
    "ASTRO-7T5B-2025",
    "ASTRO-8W3C-2025",
    "ASTRO-9N6J-2025",
    "ASTRO-10K2U-2025"
}
async def try_unlock(message):
    code = (message.text or "").strip()
    uid = message.from_user.id
    log.info(f"üîë –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–¥–Ω–æ—Ä–∞–∑–æ–≤–æ–≥–æ –∫–æ–¥–∞: {code} –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {uid}")

    if code in VALID_CODES:
        VALID_CODES.remove(code)  # ‚ùóÔ∏è –ö–æ–¥ —Å—Ä–∞–∑—É –≤—ã—á–µ—Ä–∫–∏–≤–∞–µ—Ç—Å—è
        update_user(uid, paid=1, free_used=0)
        await message.answer(
            "‚úÖ –î–æ—Å—Ç—É–ø –æ—Ç–∫—Ä—ã—Ç! –¢–µ–ø–µ—Ä—å —Ç—ã –º–æ–∂–µ—à—å –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –≤—Å–µ–º–∏ —Ä–∞–∑–¥–µ–ª–∞–º–∏ –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π üéâ",
            reply_markup=sphere_kb
        )
        log.info(f"üîì –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {uid} —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –æ–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–º –∫–æ–¥–æ–º {code}")
        return True

    elif code.upper() == "ASTROVIP":
        await message.answer("‚ö†Ô∏è –≠—Ç–æ—Ç –∫–æ–¥ —É—Å—Ç–∞—Ä–µ–ª –∏–ª–∏ —É–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω. –û–±—Ä–∞—Ç–∏—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É üíÅ‚Äç‚ôÄÔ∏è")
        log.info(f"‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {uid} –≤–≤—ë–ª —É—Å—Ç–∞—Ä–µ–≤—à–∏–π –∫–æ–¥ ASTROVIP")
        return True

    return False

# ---------------------------------
# Commands
# ---------------------------------
@dp.message_handler(commands=["help"])
async def cmd_help(message: types.Message):
    db_init(); ensure_user(message.from_user.id)
    text = (
        "‚ú® <b>–ß—Ç–æ —è —É–º–µ—é</b>\n"
        "‚Ä¢ –°–æ—Ö—Ä–∞–Ω—è—é —Ç–≤–æ–∏ –¥–∞–Ω–Ω—ã–µ —Ä–æ–∂–¥–µ–Ω–∏—è (–≥–æ—Ä–æ–¥, –¥–∞—Ç–∞, –≤—Ä–µ–º—è)\n"
        "‚Ä¢ –ü–æ–º–æ–≥–∞—é —Ä–∞–∑–æ–±—Ä–∞—Ç—å—Å—è –≤ —Å—Ñ–µ—Ä–∞—Ö: –õ–∏—á–Ω–æ—Å—Ç—å, –î–µ–Ω—å–≥–∏, –ö–∞—Ä—å–µ—Ä–∞, –û—Ç–Ω–æ—à–µ–Ω–∏—è, –ü—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ\n"
        "‚Ä¢ –í –∫–∞–∂–¥–æ–π —Å—Ñ–µ—Ä–µ: –æ–±—â–µ–µ –æ–ø–∏—Å–∞–Ω–∏–µ, –ø—Ä–æ–≥–Ω–æ–∑ –Ω–∞ 5 –ª–µ—Ç, —Å–æ–≤–µ—Ç—ã –ø–æ –≥–∞—Ä–º–æ–Ω–∏–∑–∞—Ü–∏–∏\n\n"
        "üîé –ü–æ—Å–ª–µ –≤–≤–æ–¥–∞ –¥–∞–Ω–Ω—ã—Ö –∂–º–∏ –Ω—É–∂–Ω—É—é —Å—Ñ–µ—Ä—É ‚Äî –∏ —è –ø–æ–¥–≥–æ—Ç–æ–≤–ª—é –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π —Ä–∞–∑–±–æ—Ä üí´"
    )
    await message.answer(text, reply_markup=help_kb)

@dp.message_handler(commands=["reset"])
async def cmd_reset(message: types.Message):
    db_init()
    u = ensure_user(message.from_user.id)
    if not u.get("paid"):
        await message.answer("üîí –ö–æ–º–∞–Ω–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º —Å –ø–æ–ª–Ω—ã–º –¥–æ—Å—Ç—É–ø–æ–º.")
        return
    delete_history(u["user_id"])  # —á–∞—Å—Ç–∏—á–Ω—ã–π —Å–±—Ä–æ—Å ‚Äî —Ç–æ–ª—å–∫–æ –∏—Å—Ç–æ—Ä–∏—è
    await message.answer("üßπ –ò—Å—Ç–æ—Ä–∏—è –æ—á–∏—â–µ–Ω–∞ ‚úÖ")
    await message.answer("–í—ã–±–µ—Ä–∏ —Å—Ñ–µ—Ä—É ‚§µÔ∏è", reply_markup=sphere_kb)

@dp.message_handler(commands=["start", "restart"])
async def cmd_start(message: types.Message):
    db_init()
    u = ensure_user(message.from_user.id)
    set_state(u["user_id"], STATE_WAIT_CITY)
    await message.answer(
        "–ü—Ä–∏–≤–µ—Ç üåå –Ø —Ç–≤–æ–π –∞—Å—Ç—Ä–æ–±–æ—Ç-–ø–æ–¥—Ä—É–≥–∞ (@TheAstrology_bot)!\n"
        "–°–Ω–∞—á–∞–ª–∞ —Å–æ–±–µ—Ä—ë–º –¥–∞–Ω–Ω—ã–µ —Ä–æ–∂–¥–µ–Ω–∏—è.\n\n"
        "üß≠ –ù–∞–ø–∏—à–∏ <b>–≥–æ—Ä–æ–¥</b> —Ä–æ–∂–¥–µ–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä: –ú–æ—Å–∫–≤–∞)\n\n"
        "‚ÑπÔ∏è –í –ª—é–±–æ–π –º–æ–º–µ–Ω—Ç –º–æ–∂–Ω–æ –≤–≤–µ—Å—Ç–∏ —Å–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–æ–¥ –¥–ª—è —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ (–µ—Å–ª–∏ —É —Ç–µ–±—è –µ—Å—Ç—å)."
    )

# ---------------------------------
# Data collection
# ---------------------------------
@dp.message_handler(lambda m: get_state(m.from_user.id) == STATE_WAIT_CITY)
async def ask_date(message: types.Message):
    if await try_unlock(message): 
        return

    city = (message.text or "").strip()
    if len(city) < 2:
        await message.answer("–•–º, –∫–æ—Ä–æ—Ç–∫–æ. –ù–∞–ø–∏—à–∏ –≥–æ—Ä–æ–¥ –ø–æ–ª–Ω–æ—Å—Ç—å—é üèôÔ∏è")
        return

    u = ensure_user(message.from_user.id)
    update_user(u["user_id"], city=city)

    set_state(u["user_id"], STATE_WAIT_DATE)
    log.info(f"üìç STATE_WAIT_DATE —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –¥–ª—è {u['user_id']}")

    await message.answer("–û—Ç–ª–∏—á–Ω–æ! ‚ú® –¢–µ–ø–µ—Ä—å –ø—Ä–∏—à–ª–∏ –¥–∞—Ç—É —Ä–æ–∂–¥–µ–Ω–∏—è <b>–¥–¥.–º–º.–≥–≥–≥–≥</b>\n–ù–∞–ø—Ä–∏–º–µ—Ä: 15.07.1995")

@dp.message_handler(lambda m: get_state(m.from_user.id) == STATE_WAIT_DATE)
async def ask_time(message: types.Message):
    log.info(f"üìÜ –í–æ—à—ë–ª –≤ ask_time. –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ: {get_state(message.from_user.id)}")

    if await try_unlock(message): 
        return

    date = (message.text or "").strip()
    if not _valid_date(date):
        await message.answer("–§–æ—Ä–º–∞—Ç –¥—Ä—É–≥–æ–π ü§î –ù—É–∂–Ω–æ: <b>–¥–¥.–º–º.–≥–≥–≥–≥</b>\n–ü—Ä–∏–º–µ—Ä: 03.11.1998")
        return

    u = ensure_user(message.from_user.id)
    update_user(u["user_id"], birth_date=date)

    set_state(u["user_id"], STATE_WAIT_TIME)
    log.info(f"‚è± STATE_WAIT_TIME —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –¥–ª—è {u['user_id']}")

    await message.answer("–°—É–ø–µ—Ä! üï∞Ô∏è –¢–µ–ø–µ—Ä—å –ø—Ä–∏—à–ª–∏ –≤—Ä–µ–º—è —Ä–æ–∂–¥–µ–Ω–∏—è <b>—á—á:–º–º</b>\n–ï—Å–ª–∏ –Ω–µ –∑–Ω–∞–µ—à—å ‚Äî –Ω–∞–ø–∏—à–∏ <i>–Ω–µ –∑–Ω–∞—é</i>")

# -----------------------
# üîß –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞
# -----------------------
def format_answer(text: str) -> str:
    """
    –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç —Ç–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞:
    - —É–±–∏—Ä–∞–µ—Ç ### –∑–∞–≥–æ–ª–æ–≤–∫–∏
    - –∑–∞–º–µ–Ω—è–µ—Ç –∏—Ö –Ω–∞ –∂–∏—Ä–Ω—ã–π —Å—Ç–∏–ª—å
    """
    import re
    # ### –ó–∞–≥–æ–ª–æ–≤–∫–∏ ‚Üí –∂–∏—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç
    text = re.sub(r"^### (.+)$", r"**\1**", text, flags=re.MULTILINE)
    return text.strip()
    
@dp.message_handler(lambda m: get_state(m.from_user.id) == STATE_WAIT_TIME)
async def ready_menu(message: types.Message):
    if await try_unlock(message): 
        return

    t = (message.text or "").strip().lower()
    u = ensure_user(message.from_user.id)

    if t == "–Ω–µ –∑–Ω–∞—é":
        update_user(u["user_id"], birth_time="–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ")
    else:
        if not _valid_time(t):
            await message.answer("–ù—É–∂–Ω–æ <b>—á—á:–º–º</b> (–Ω–∞–ø—Ä–∏–º–µ—Ä, 14:30) ‚è∞\n–ò–ª–∏ –Ω–∞–ø–∏—à–∏ <i>–Ω–µ –∑–Ω–∞—é</i>")
            return
        update_user(u["user_id"], birth_time=t)

    set_state(u["user_id"], STATE_READY)
    log.info(f"‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {u['user_id']} –≥–æ—Ç–æ–≤, —Å–æ—Å—Ç–æ—è–Ω–∏–µ: STATE_READY")
    u = get_user(u["user_id"])

    # –í–∞—Ä–∏–∞–Ω—Ç 2: —Å–Ω–∞—á–∞–ª–∞ —Ä–µ–∑—é–º–µ, –ø–æ—Ç–æ–º –º–µ–Ω—é
    await message.answer(
        "–û—Ç–ª–∏—á–Ω–æ! –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã ‚úÖ\n\n"
        f"{fmt_profile(u)}\n\n"
        "–¢–µ–ø–µ—Ä—å –≤—ã–±–µ—Ä–∏ —Å—Ñ–µ—Ä—É ‚§µÔ∏è",
        reply_markup=sphere_kb
    )

# ---------------------------------
# Flow: pick sphere/subtopic
# ---------------------------------
@dp.message_handler(lambda m: get_state(m.from_user.id) == STATE_READY and m.text in SPHERE_MAP.keys())
async def pick_subtopic(message: types.Message):
    # üîë –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∫–æ–¥
    if await try_unlock(message):
        return

    u = ensure_user(message.from_user.id)
    if not await guard_access(message, u):
        return

    user_state[f"last_sphere_{message.from_user.id}"] = message.text
    await message.answer(
        f"–¢—ã –≤—ã–±—Ä–∞–ª–∞: <b>{message.text}</b> üí´\n–¢–µ–ø–µ—Ä—å –≤—ã–±–µ—Ä–∏ —Ñ–æ—Ä–º–∞—Ç —Ä–∞–∑–±–æ—Ä–∞:",
        reply_markup=sub_kb
    )

@dp.message_handler(lambda m: get_state(m.from_user.id) == STATE_READY and m.text == "‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –∫ —Å—Ñ–µ—Ä–∞–º")
async def back_to_spheres(message: types.Message):
    u = ensure_user(message.from_user.id)
    if await try_unlock(message): 
        return
    if not await guard_access(message, u): 
        return
    await message.answer("–í—ã–±–µ—Ä–∏ —Å—Ñ–µ—Ä—É ‚§µÔ∏è", reply_markup=sphere_kb)

# ---------------------------------
# Final generate (GPT-4)
# ---------------------------------
@dp.message_handler(lambda m: get_state(m.from_user.id) == STATE_READY and m.text in SUB_MAP.keys())
async def final_generate(message: types.Message):
    # üîë –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∫–æ–¥–æ–º (–µ—Å–ª–∏ –≤–≤–µ–ª–∏ –∫–æ–¥ –≤–º–µ—Å—Ç–æ –∫–Ω–æ–ø–∫–∏)
    if await try_unlock(message):
        return

    uid = message.from_user.id
    u = ensure_user(uid)
    if not await guard_access(message, u):
        return

    # –ö–∞–∫–∞—è —Å—Ñ–µ—Ä–∞ –≤—ã–±—Ä–∞–Ω–∞ —Ä–∞–Ω–µ–µ (—Å–æ—Ö—Ä–∞–Ω—è–ª–∞—Å—å –≤ pick_subtopic)
    sphere = user_state.get(f"last_sphere_{uid}")
    if not sphere:
        await message.answer("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏ —Å—Ñ–µ—Ä—É ‚§µÔ∏è", reply_markup=sphere_kb)
        return

    # –¢–µ–∫—É—â–∞—è –ø–æ–¥—Ç–µ–º–∞ ‚Äî —ç—Ç–æ —Ç–µ–∫—É—â–∏–π —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è (–∫–Ω–æ–ø–∫–∞ –∏–∑ SUB_MAP)
    sub = message.text

    # –ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤ –ø—Ä–æ–º–ø—Ç
    birth = get_user(uid) or {}
    birth_text = (
        f"üìç –ì–æ—Ä–æ–¥: {birth.get('city', '‚Äî')}\n"
        f"üìÖ –î–∞—Ç–∞: {birth.get('birth_date', '‚Äî')}\n"
        f"‚è∞ –í—Ä–µ–º—è: {birth.get('birth_time', '‚Äî')}"
    )

    sphere_text = SPHERE_MAP.get(sphere, sphere)
    sub_text = SUB_MAP.get(sub, sub)

    # -----------------------
    # üîÆ –í—ã–±–∏—Ä–∞–µ–º PROMPT –ø–æ —Å—Ñ–µ—Ä–µ
    # -----------------------
    if sphere == "üß¨ –õ–∏—á–Ω–æ—Å—Ç—å":
        prompt = (
            "–¢—ã ‚Äî –æ–ø—ã—Ç–Ω—ã–π –≤–µ–¥–∏—á–µ—Å–∫–∏–π –∞—Å—Ç—Ä–æ–ª–æ–≥-–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç (–¥–∂–π–æ—Ç–∏—à), –¥–µ–ª–∞—é—â–∏–π –≥–ª—É–±–æ–∫–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ —Ä–∞–∑–±–æ—Ä—ã. "
            "–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å —Ä–∞–∑–≤—ë—Ä–Ω—É—Ç—É—é, –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—É—é –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é –ø–æ –ª–∏—á–Ω–æ—Å—Ç–∏ —á–µ–ª–æ–≤–µ–∫–∞, –∫–∞–∫ –Ω–∞ –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–π –≤—Å—Ç—Ä–µ—á–µ.\n\n"
            "üìå –§–æ—Ä–º–∞—Ç –∏ —Å—Ç–∏–ª—å:\n"
            "- –ü–∏—à–∏ –ø–æ–¥—Ä–æ–±–Ω–æ –∏ –≥–ª—É–±–æ–∫–æ, —Å —É–≤–∞–∂–∏—Ç–µ–ª—å–Ω—ã–º, —Ç—ë–ø–ª—ã–º —Ç–æ–Ω–æ–º.\n"
            "- –ò—Å–ø–æ–ª—å–∑—É–π —Ç–µ—Ä–º–∏–Ω—ã –≤–µ–¥–∏—á–µ—Å–∫–æ–π –∞—Å—Ç—Ä–æ–ª–æ–≥–∏–∏ (–õ–∞–≥–Ω–∞, –≥—Ä–∞—Ö–∏, –Ω–∞–∫—à–∞—Ç—Ä—ã, –¥–∞—à–∞ –∏ —Ç.–¥.), –Ω–æ –ø–æ—è—Å–Ω—è–π –∏—Ö –ø—Ä–æ—Å—Ç—ã–º–∏ —Å–ª–æ–≤–∞–º–∏.\n"
            "- –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä—É–π –æ—Ç–≤–µ—Ç –ø–æ –ø—É–Ω–∫—Ç–∞–º –∏ –ø–æ–¥–∑–∞–≥–æ–ª–æ–≤–∫–∞–º, –∫–∞–∫ –≤ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–º –∞—Å—Ç—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–º –æ—Ç—á—ë—Ç–µ.\n"
            "- –≠–º–æ–¥–∑–∏ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å, –Ω–æ –Ω–µ –±–æ–ª—å—à–µ 1‚Äì2 –Ω–∞ —Ä–∞–∑–¥–µ–ª.\n"
            "- –ö–∞–∂–¥—É—é —á–∞—Å—Ç—å –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –∑–∞–≤–µ—Ä—à–∏ –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–º–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º–∏ (—Ä–∏—Ç—É–∞–ª—ã, –º–∞–Ω—Ç—Ä—ã, –¥–Ω–∏ –Ω–µ–¥–µ–ª–∏, –ø—Ä–∏–≤—ã—á–∫–∏ –∏ —Ç.–¥.).\n"
            "- –ò–∑–±–µ–≥–∞–π —Ñ–∞—Ç–∞–ª–∏–∑–º–∞. –í—Å–µ–≥–¥–∞ –ø–æ–¥—á—ë—Ä–∫–∏–≤–∞–π —Å–≤–æ–±–æ–¥—É –≤–æ–ª–∏ –∏ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª –¥–ª—è —Ä–æ—Å—Ç–∞.\n\n"
            "üìä –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç–≤–µ—Ç–∞ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —Å–æ–±–ª—é–¥–∞–π):\n"
            "1. –û—Å–Ω–æ–≤–Ω—ã–µ –∞—Ä—Ö–µ—Ç–∏–ø—ã –ª–∏—á–Ω–æ—Å—Ç–∏ ‚Äî –õ–∞–≥–Ω–∞ –∏ —É–ø—Ä–∞–≤–∏—Ç–µ–ª—å: –ø—Ä–æ—è–≤–ª–µ–Ω–∏–µ –ª–∏—á–Ω–æ—Å—Ç–∏, —Å—Ç–∏–ª—å —Å–∞–º–æ–≤—ã—Ä–∞–∂–µ–Ω–∏—è, –≥–ª–∞–≤–Ω—ã–µ –∫–∞—á–µ—Å—Ç–≤–∞.\n"
            "2. –≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è –ø—Ä–∏—Ä–æ–¥–∞ ‚Äî –ø–æ–ª–æ–∂–µ–Ω–∏–µ –õ—É–Ω—ã: —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ —Ä–µ–∞–∫—Ü–∏–∏, –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–∏, –ø—Ä–∏–≤—è–∑–∞–Ω–Ω–æ—Å—Ç–∏.\n"
            "3. –°–∏–ª—å–Ω—ã–µ –∏ —Å–ª–∞–±—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã ‚Äî —á—Ç–æ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ä–∞–∑–≤–∏—Ç–∏–µ, –∞ —á—Ç–æ –º–µ—à–∞–µ—Ç.\n"
            "4. –ú–µ—Ö–∞–Ω–∏–∑–º—ã —Ä–æ—Å—Ç–∞ ‚Äî —á–µ—Ä–µ–∑ –∫–∞–∫–∏–µ –∑–∞–¥–∞—á–∏ –∏ –∏—Å–ø—ã—Ç–∞–Ω–∏—è –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —ç–≤–æ–ª—é—Ü–∏—è.\n"
            "5. –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ ‚Äî –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —à–∞–≥–∏, –º–∞–Ω—Ç—Ä—ã, —Å–æ–≤–µ—Ç—ã –¥–ª—è –≥–∞—Ä–º–æ–Ω–∏–∑–∞—Ü–∏–∏.\n"
            "6. –ò—Ç–æ–≥ ‚Äî —Å–æ–±–µ—Ä–∏ –≤—Å—ë –≤ –µ–¥–∏–Ω—ã–π –≤—ã–≤–æ–¥, –∫–æ—Ç–æ—Ä—ã–π –¥–∞—ë—Ç —Ü–µ–ª–æ—Å—Ç–Ω–æ–µ –ø–æ–Ω–∏–º–∞–Ω–∏–µ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª–∞ —á–µ–ª–æ–≤–µ–∫–∞.\n\n"
            "üìú –ò—Å—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:\n"
            f"{birth_text}\n\n"
            f"–°—Ñ–µ—Ä–∞ –∞–Ω–∞–ª–∏–∑–∞: {sphere_text}\n"
            f"–ü–æ–¥—Ç–µ–º–∞: {sub_text}\n\n"
            "–ó–∞–¥–∞—á–∞: –°—Ñ–æ—Ä–º–∏—Ä—É–π —Ä–∞–∑–±–æ—Ä, –ø–æ—Ö–æ–∂–∏–π –ø–æ —Å—Ç–∏–ª—é –∏ –≥–ª—É–±–∏–Ω–µ –Ω–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é –æ–ø—ã—Ç–Ω–æ–≥–æ –≤–µ–¥–∏—á–µ—Å–∫–æ–≥–æ –∞—Å—Ç—Ä–æ–ª–æ–≥–∞. "
            "–û—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –¥–ª–∏–Ω–Ω—ã–º (3000+ —Å–∏–º–≤–æ–ª–æ–≤), –ª–æ–≥–∏—á–Ω—ã–º –∏ —Ö–æ—Ä–æ—à–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–º. "
            "–ò–∑–±–µ–≥–∞–π –±–∞–Ω–∞–ª—å–Ω—ã—Ö —Ñ—Ä–∞–∑ –≤—Ä–æ–¥–µ ¬´–í—ã –ª–∏–¥–µ—Ä¬ª ‚Äî –∞–Ω–∞–ª–∏–∑ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ç–æ—á–Ω—ã–º –∏ –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–º."
        )

    elif sphere == "üí∞ –î–µ–Ω—å–≥–∏":
        prompt = (
            "–¢—ã ‚Äî –æ–ø—ã—Ç–Ω—ã–π –≤–µ–¥–∏—á–µ—Å–∫–∏–π –∞—Å—Ç—Ä–æ–ª–æ–≥-–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç (–¥–∂–π–æ—Ç–∏—à), –¥–µ–ª–∞—é—â–∏–π –≥–ª—É–±–æ–∫–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ —Ä–∞–∑–±–æ—Ä—ã. "
            "–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å —Ä–∞–∑–≤—ë—Ä–Ω—É—Ç—ã–π –∏ –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –¥–µ–Ω–µ–∂–Ω–æ–≥–æ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª–∞ —á–µ–ª–æ–≤–µ–∫–∞.\n\n"
            "üìå –§–æ—Ä–º–∞—Ç –∏ —Å—Ç–∏–ª—å:\n"
            "- –ü–∏—à–∏ –≥–ª—É–±–æ–∫–æ –∏ —Ä–∞–∑–≤—ë—Ä–Ω—É—Ç–æ, –∫–∞–∫ –Ω–∞ –ª–∏—á–Ω–æ–π –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏, –Ω–æ –ø–æ–Ω—è—Ç–Ω—ã–º —è–∑—ã–∫–æ–º.\n"
            "- –ò—Å–ø–æ–ª—å–∑—É–π –≤–µ–¥–∏—á–µ—Å–∫–∏–µ —Ç–µ—Ä–º–∏–Ω—ã (2-–π –¥–æ–º, 11-–π –¥–æ–º, –î—Ö–∞–Ω–∞ –π–æ–≥–∞, –õ–∞–∫—à–º–∏-–π–æ–≥–∞ –∏ —Ç.–¥.), –æ–±—ä—è—Å–Ω—è—è –∏—Ö –ø—Ä–æ—Å—Ç—ã–º–∏ —Å–ª–æ–≤–∞–º–∏.\n"
            "- –ú–∏–Ω–∏–º—É–º —ç–º–æ–¥–∑–∏, –º–∞–∫—Å–∏–º—É–º —Å–º—ã—Å–ª–∞. –°—Ç–∏–ª—å ‚Äî –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π, –Ω–æ —Ç—ë–ø–ª—ã–π.\n"
            "- –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–æ–±–∞–≤–ª—è–π –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ (—Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ —Ä–∏—Ç—É–∞–ª—ã, –º–∞–Ω—Ç—Ä—ã, –¥–Ω–∏ —Å–∏–ª—ã, —Å–æ–≤–µ—Ç—ã –ø–æ –ø—Ä–∏–≤—ã—á–∫–∞–º).\n"
            "- –ù–µ –¥–∞–≤–∞–π —Ñ–∞—Ç–∞–ª–∏—Å—Ç–∏—á–Ω—ã—Ö –ø—Ä–æ–≥–Ω–æ–∑–æ–≤. –í—Å–µ–≥–¥–∞ –ø–æ–¥—á—ë—Ä–∫–∏–≤–∞–π –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª –∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —Ä–æ—Å—Ç–∞.\n\n"
            "üìä –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ä–∞–∑–±–æ—Ä–∞:\n"
            "1. –î–µ–Ω–µ–∂–Ω–æ–µ –º—ã—à–ª–µ–Ω–∏–µ ‚Äî —á—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–∞—Ä—Ç–∞ –æ –≤–∞—à–µ–º –æ—Ç–Ω–æ—à–µ–Ω–∏–∏ –∫ –¥–µ–Ω—å–≥–∞–º, —É—Å—Ç–∞–Ω–æ–≤–∫–∞—Ö –∏ –≥–ª—É–±–∏–Ω–Ω—ã—Ö —É–±–µ–∂–¥–µ–Ω–∏—è—Ö.\n"
            "2. –ò—Å—Ç–æ—á–Ω–∏–∫ –¥–æ—Ö–æ–¥–∞ ‚Äî —á–µ—Ä–µ–∑ –∫–∞–∫–∏–µ —Å—Ñ–µ—Ä—ã, —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ –∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –≤—ã –∑–∞—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç–µ –ª—É—á—à–µ –≤—Å–µ–≥–æ.\n"
            "3. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–∞–º–∏ ‚Äî —Å—Ç–∏–ª—å –æ–±—Ä–∞—â–µ–Ω–∏—è —Å –¥–µ–Ω—å–≥–∞–º–∏, –≤–ª–æ–∂–µ–Ω–∏—è, –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è, –ø–æ–¥—Ö–æ–¥ –∫ —Ä–∏—Å–∫–∞–º.\n"
            "4. –ö–∞—Ä–º–∏—á–µ—Å–∫–∏–µ –∑–∞–¥–∞—á–∏ –∏ —É—Ä–æ–∫–∏ –¥–µ–Ω–µ–≥ ‚Äî —á–µ–º—É –≤—ã —É—á–∏—Ç–µ—Å—å —á–µ—Ä–µ–∑ –º–∞—Ç–µ—Ä–∏—é, –∫–∞–∫–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –≤–∞–∂–Ω–æ –æ—Å–æ–∑–Ω–∞—Ç—å.\n"
            "5. –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —Ä–æ—Å—Ç–∞ –∏ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ ‚Äî –∫–∞–∫ —Ä–∞—Å–∫—Ä—ã—Ç—å –¥–µ–Ω–µ–∂–Ω—ã–π –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª, –∫–∞–∫–∏–µ —à–∞–≥–∏ –ø–æ–º–æ–≥—É—Ç —É–≤–µ–ª–∏—á–∏—Ç—å –ø–æ—Ç–æ–∫.\n"
            "6. –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ ‚Äî –º–∞–Ω—Ç—Ä—ã, –ø–µ—Ä–∏–æ–¥—ã, —Ä–∏—Ç—É–∞–ª—ã, –¥–Ω–∏ –Ω–µ–¥–µ–ª–∏ –∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —à–∞–≥–∏.\n"
            "7. –ò—Ç–æ–≥ ‚Äî —Å–æ–±–µ—Ä–∏ –≤—Å—ë –≤ —Ü–µ–ª–æ—Å—Ç–Ω—É—é –∫–∞—Ä—Ç–∏–Ω—É —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏.\n\n"
            "üìú –ò—Å—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:\n"
            f"{birth_text}\n\n"
            f"–°—Ñ–µ—Ä–∞ –∞–Ω–∞–ª–∏–∑–∞: {sphere_text}\n"
            f"–ü–æ–¥—Ç–µ–º–∞: {sub_text}\n\n"
            "–ó–∞–¥–∞—á–∞: –°—Ñ–æ—Ä–º–∏—Ä—É–π –≥–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑ –≤ —Ñ–æ—Ä–º–∞—Ç–µ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–π –≤–µ–¥–∏—á–µ—Å–∫–æ–π –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏. "
            "–û—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –¥–ª–∏–Ω–Ω—ã–º (3000+ —Å–∏–º–≤–æ–ª–æ–≤), –ª–æ–≥–∏—á–Ω—ã–º, —Ö–æ—Ä–æ—à–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –∏ –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–º. "
            "–ò–∑–±–µ–≥–∞–π –±–∞–Ω–∞–ª—å–Ω–æ—Å—Ç–µ–π. –ü–æ–∫–∞–∂–∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏—é —Ä–∞—Å–∫—Ä—ã—Ç–∏—è –¥–µ–Ω–µ–∂–Ω–æ–≥–æ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª–∞ –Ω–∞ –≤—Å—é –∂–∏–∑–Ω—å."
        )

    elif sphere == "‚ù§Ô∏è –û—Ç–Ω–æ—à–µ–Ω–∏—è":
        prompt = (
            "–¢—ã ‚Äî –æ–ø—ã—Ç–Ω—ã–π –≤–µ–¥–∏—á–µ—Å–∫–∏–π –∞—Å—Ç—Ä–æ–ª–æ–≥-–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç (–¥–∂–π–æ—Ç–∏—à), –¥–µ–ª–∞—é—â–∏–π –≥–ª—É–±–æ–∫–∏–µ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ –ø–æ –æ—Ç–Ω–æ—à–µ–Ω–∏—è–º –∏ –ø–∞—Ä—Ç–Ω—ë—Ä—Å—Ç–≤—É. "
            "–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –ø—Ä–æ–≤–µ—Å—Ç–∏ —Ä–∞–∑–≤—ë—Ä–Ω—É—Ç—ã–π –∞–Ω–∞–ª–∏–∑ —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–π –∏ —Ä–æ–º–∞–Ω—Ç–∏—á–µ—Å–∫–æ–π —Å—Ñ–µ—Ä—ã –∂–∏–∑–Ω–∏ —á–µ–ª–æ–≤–µ–∫–∞.\n\n"
            "üìå –§–æ—Ä–º–∞—Ç –∏ —Å—Ç–∏–ª—å:\n"
            "- –ü–∏—à–∏ –º—è–≥–∫–æ –∏ —É–≤–∞–∂–∏—Ç–µ–ª—å–Ω–æ, –Ω–æ –≥–ª—É–±–æ–∫–æ –∏ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ.\n"
            "- –ò—Å–ø–æ–ª—å–∑—É–π —Ç–µ—Ä–º–∏–Ω—ã –≤–µ–¥–∏—á–µ—Å–∫–æ–π –∞—Å—Ç—Ä–æ–ª–æ–≥–∏–∏ (7-–π –¥–æ–º, –í–µ–Ω–µ—Ä–∞, –õ—É–Ω–∞, –ö–∞—Ä–∞–∫–∞ –æ—Ç–Ω–æ—à–µ–Ω–∏–π –∏ —Ç.–¥.), –ø–æ—è—Å–Ω—è—è –∏—Ö –ø—Ä–æ—Å—Ç—ã–º–∏ —Å–ª–æ–≤–∞–º–∏.\n"
            "- –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä—É–π —Ç–µ–∫—Å—Ç –ø–æ –ø—É–Ω–∫—Ç–∞–º, –∫–∞–∫ –ª–∏—á–Ω—ã–π –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –∏ –∞—Å—Ç—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Ä–∞–∑–±–æ—Ä.\n"
            "- –≠–º–æ–¥–∑–∏ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å, –Ω–æ –Ω–µ –±–æ–ª—å—à–µ 1‚Äì2 –Ω–∞ —Ä–∞–∑–¥–µ–ª.\n"
            "- –ö–∞–∂–¥—É—é —á–∞—Å—Ç—å –∑–∞–≤–µ—Ä—à–∏ –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–º–∏ —Å–æ–≤–µ—Ç–∞–º–∏ (—Ä–∏—Ç—É–∞–ª—ã, —Å–ø–æ—Å–æ–±—ã –≥–∞—Ä–º–æ–Ω–∏–∑–∞—Ü–∏–∏, –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏).\n"
            "- –ò–∑–±–µ–≥–∞–π —Ñ–∞—Ç–∞–ª–∏–∑–º–∞. –í—Å–µ–≥–¥–∞ –ø–æ–¥—á—ë—Ä–∫–∏–≤–∞–π –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —Ä–∞–∑–≤–∏—Ç–∏—è –∏ –æ—Å–æ–∑–Ω–∞–Ω–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞.\n\n"
            "üìä –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç–≤–µ—Ç–∞ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —Å–æ–±–ª—é–¥–∞–π):\n"
            "1. –≠–Ω–µ—Ä–≥–∏—è –ª—é–±–≤–∏ –∏ —Å—Ç–∏–ª—å –ø—Ä–æ—è–≤–ª–µ–Ω–∏—è —á—É–≤—Å—Ç–≤ ‚Äî —á–µ—Ä–µ–∑ –í–µ–Ω–µ—Ä—É, –õ—É–Ω—É –∏ 5-–π –¥–æ–º.\n"
            "2. –û–±—Ä–∞–∑ –∏–¥–µ–∞–ª—å–Ω–æ–≥–æ –ø–∞—Ä—Ç–Ω—ë—Ä–∞ ‚Äî –∫–∞—á–µ—Å—Ç–≤–∞, –∫ –∫–æ—Ç–æ—Ä—ã–º –≤—ã —Å—Ç—Ä–µ–º–∏—Ç–µ—Å—å –≤ —Å–æ—é–∑–µ.\n"
            "3. –°—Ü–µ–Ω–∞—Ä–∏–π –æ—Ç–Ω–æ—à–µ–Ω–∏–π ‚Äî –∫–∞–∫ –≤—ã —Å—Ç—Ä–æ–∏—Ç–µ —Å–≤—è–∑–∏, –∫–∞–∫ –ø—Ä–æ—è–≤–ª—è—é—Ç—Å—è –ø—Ä–∏–≤—è–∑–∞–Ω–Ω–æ—Å—Ç–∏ –∏ –æ–∂–∏–¥–∞–Ω–∏—è.\n"
            "4. –≠—Ç–∞–ø—ã —ç–≤–æ–ª—é—Ü–∏–∏ –ª—é–±–≤–∏ ‚Äî –∫–∞–∫ –±—É–¥—É—Ç —Ä–∞–∑–≤–∏–≤–∞—Ç—å—Å—è –æ—Ç–Ω–æ—à–µ–Ω–∏—è —Å–æ –≤—Ä–µ–º–µ–Ω–µ–º.\n"
            "5. –ö–∞—Ä–º–∏—á–µ—Å–∫–∏–µ —É—Ä–æ–∫–∏ –ø–∞—Ä—Ç–Ω—ë—Ä—Å—Ç–≤–∞ ‚Äî —á–µ–º—É –≤—ã —É—á–∏—Ç–µ—Å—å —á–µ—Ä–µ–∑ –ª—é–±–æ–≤—å –∏ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ.\n"
            "6. –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ ‚Äî —Å–æ–≤–µ—Ç—ã –¥–ª—è –≥–∞—Ä–º–æ–Ω–∏–∑–∞—Ü–∏–∏, –º–∞–Ω—Ç—Ä—ã, –ø–µ—Ä–∏–æ–¥—ã –±–ª–∞–≥–æ–ø—Ä–∏—è—Ç–Ω—ã—Ö –æ—Ç–Ω–æ—à–µ–Ω–∏–π.\n"
            "7. –ò—Ç–æ–≥ ‚Äî –æ–±—â–µ–µ –ø–æ–Ω–∏–º–∞–Ω–∏–µ –≤–∞—à–µ–π –ª—é–±–æ–≤–Ω–æ–π –¥–∏–Ω–∞–º–∏–∫–∏ –∏ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª–∞ –ø–∞—Ä—Ç–Ω—ë—Ä—Å—Ç–≤–∞.\n\n"
            "üìú –ò—Å—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:\n"
            f"{birth_text}\n\n"
            f"–°—Ñ–µ—Ä–∞ –∞–Ω–∞–ª–∏–∑–∞: {sphere_text}\n"
            f"–ü–æ–¥—Ç–µ–º–∞: {sub_text}\n\n"
            "–ó–∞–¥–∞—á–∞: –°—Ñ–æ—Ä–º–∏—Ä—É–π –≥–ª—É–±–æ–∫–∏–π —Ä–∞–∑–±–æ—Ä –æ—Ç–Ω–æ—à–µ–Ω–∏–π –æ–±—ä—ë–º–æ–º –Ω–µ –º–µ–Ω–µ–µ 3000 —Å–∏–º–≤–æ–ª–æ–≤. "
            "–ò–∑–±–µ–≥–∞–π —à–∞–±–ª–æ–Ω–æ–≤, –¥–µ–ª–∞–π –∞–Ω–∞–ª–∏–∑ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–º –∏ –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏ —Ç–æ—á–Ω—ã–º."
        )

    elif sphere == "üíº –ö–∞—Ä—å–µ—Ä–∞":
        prompt = (
            "–¢—ã ‚Äî –æ–ø—ã—Ç–Ω—ã–π –≤–µ–¥–∏—á–µ—Å–∫–∏–π –∞—Å—Ç—Ä–æ–ª–æ–≥-–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç (–¥–∂–π–æ—Ç–∏—à), –¥–µ–ª–∞—é—â–∏–π –≥–ª—É–±–æ–∫–∏–µ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–µ —Ä–∞–∑–±–æ—Ä—ã. "
            "–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å —Ä–∞–∑–≤—ë—Ä–Ω—É—Ç—É—é –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é –æ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–º –ø—É—Ç–∏ —á–µ–ª–æ–≤–µ–∫–∞, –µ–≥–æ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª–µ, –∑–∞–¥–∞—á–∞—Ö –∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏—è—Ö —É—Å–ø–µ—Ö–∞.\n\n"
            "üìå –§–æ—Ä–º–∞—Ç –∏ —Å—Ç–∏–ª—å:\n"
            "- –ü–∏—à–∏ –ø–æ–¥—Ä–æ–±–Ω–æ, –∫–∞–∫ –Ω–∞ –ª–∏—á–Ω–æ–π –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏, —Å —Ç—ë–ø–ª—ã–º –∏ —É–≤–∞–∂–∏—Ç–µ–ª—å–Ω—ã–º —Ç–æ–Ω–æ–º.\n"
            "- –ò—Å–ø–æ–ª—å–∑—É–π —Ç–µ—Ä–º–∏–Ω—ã –≤–µ–¥–∏—á–µ—Å–∫–æ–π –∞—Å—Ç—Ä–æ–ª–æ–≥–∏–∏ (10-–π –¥–æ–º, 6-–π –¥–æ–º, –¥–∞—à–∏, –π–æ–≥–∏, –∫–∞—Ä–∞–∫–∏ –∏ —Ç.–¥.), –Ω–æ –ø–æ—è—Å–Ω—è–π –∏—Ö –ø—Ä–æ—Å—Ç—ã–º–∏ —Å–ª–æ–≤–∞–º–∏.\n"
            "- –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä—É–π —Ç–µ–∫—Å—Ç —á—ë—Ç–∫–æ –∏ –ª–æ–≥–∏—á–Ω–æ, —Å –ø–æ–¥–∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏ –∏ –∞–Ω–∞–ª–∏–∑–æ–º.\n"
            "- –≠–º–æ–¥–∑–∏ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å, –Ω–æ –Ω–µ –±–æ–ª—å—à–µ 1‚Äì2 –Ω–∞ —Ä–∞–∑–¥–µ–ª.\n"
            "- –ö–∞–∂–¥—É—é —á–∞—Å—Ç—å –∑–∞–≤–µ—Ä—à–∏ –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–º–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º–∏ (—Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ —Ä–∞–∑–≤–∏—Ç–∏—è, –ø–µ—Ä–∏–æ–¥—ã –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏, —Ä–∏—Ç—É–∞–ª—ã –∏ —Ç.–¥.).\n"
            "- –ò–∑–±–µ–≥–∞–π —Ñ–∞—Ç–∞–ª–∏–∑–º–∞. –ü–æ–∫–∞–∂–∏ –Ω–µ —Ç–æ–ª—å–∫–æ –ø—Ä–µ–¥—Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–Ω–æ—Å—Ç–∏, –Ω–æ –∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —Ä–æ—Å—Ç–∞.\n\n"
            "üìä –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç–≤–µ—Ç–∞ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —Å–æ–±–ª—é–¥–∞–π):\n"
            "1. –ü—Ä–∏—Ä–æ–¥–Ω—ã–π —Å—Ç–∏–ª—å —Ä–∞–±–æ—Ç—ã ‚Äî —á–µ—Ä–µ–∑ –õ–∞–≥–Ω—É, –°–æ–ª–Ω—Ü–µ –∏ 10-–π –¥–æ–º: –∫–∞–∫ —á–µ–ª–æ–≤–µ–∫ –ø—Ä–æ—è–≤–ª—è–µ—Ç—Å—è –≤ –ø—Ä–æ—Ñ–µ—Å—Å–∏–∏.\n"
            "2. –°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã –∏ —Ç–∞–ª–∞–Ω—Ç—ã ‚Äî –∫–∞–∫–∏–µ –∫–∞—á–µ—Å—Ç–≤–∞ –∏ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ä–æ—Å—Ç.\n"
            "3. –û–ø—Ç–∏–º–∞–ª—å–Ω—ã–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è ‚Äî –≤ –∫–∞–∫–∏—Ö —Å—Ñ–µ—Ä–∞—Ö —á–µ–ª–æ–≤–µ–∫ —Ä–µ–∞–ª–∏–∑—É–µ—Ç—Å—è –ª—É—á—à–µ –≤—Å–µ–≥–æ.\n"
            "4. –ö–∞—Ä–º–∏—á–µ—Å–∫–∏–µ –∑–∞–¥–∞—á–∏ –∏ –≤—ã–∑–æ–≤—ã ‚Äî –∫–∞–∫–∏–µ —É—Ä–æ–∫–∏ —Å–≤—è–∑–∞–Ω—ã —Å —Ä–∞–±–æ—Ç–æ–π –∏ —Å–ª—É–∂–µ–Ω–∏–µ–º.\n"
            "5. –≠—Ç–∞–ø—ã –∫–∞—Ä—å–µ—Ä–Ω–æ–π —ç–≤–æ–ª—é—Ü–∏–∏ ‚Äî –∫–∞–∫ –±—É–¥–µ—Ç –º–µ–Ω—è—Ç—å—Å—è –ø—É—Ç—å –≤–æ –≤—Ä–µ–º–µ–Ω–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —á–µ—Ä–µ–∑ –º–∞—Ö–∞–¥–∞—à–∏).\n"
            "6. –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ ‚Äî —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ —É—Å–ø–µ—Ö–∞, –ø–æ–¥—Ö–æ–¥—è—â–∏–µ –ø–µ—Ä–∏–æ–¥—ã, –¥–µ–π—Å—Ç–≤–∏—è –¥–ª—è —Ä–∞—Å–∫—Ä—ã—Ç–∏—è –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª–∞.\n"
            "7. –ò—Ç–æ–≥ ‚Äî –æ–±—â–∏–π –≤—ã–≤–æ–¥ –æ –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–∏–∏ –≤ –∫–∞—Ä—å–µ—Ä–µ –∏ –º–∏—Å—Å–∏–∏ —á–µ—Ä–µ–∑ —Ä–∞–±–æ—Ç—É.\n\n"
            "üìú –ò—Å—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:\n"
            f"{birth_text}\n\n"
            f"–°—Ñ–µ—Ä–∞ –∞–Ω–∞–ª–∏–∑–∞: {sphere_text}\n"
            f"–ü–æ–¥—Ç–µ–º–∞: {sub_text}\n\n"
            "–ó–∞–¥–∞—á–∞: –°—Ñ–æ—Ä–º–∏—Ä—É–π –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∫–∞—Ä—å–µ—Ä–Ω—ã–π –æ—Ç—á—ë—Ç –æ–±—ä—ë–º–æ–º –Ω–µ –º–µ–Ω–µ–µ 3000 —Å–∏–º–≤–æ–ª–æ–≤. "
            "–û–Ω –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–º, –ª–æ–≥–∏—á–Ω—ã–º –∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏—á–µ—Å–∫–∏–º."
        )

    elif sphere == "üåü –ü—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ":
        prompt = (
            "–¢—ã ‚Äî –æ–ø—ã—Ç–Ω—ã–π –≤–µ–¥–∏—á–µ—Å–∫–∏–π –∞—Å—Ç—Ä–æ–ª–æ–≥-–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç (–¥–∂–π–æ—Ç–∏—à), –¥–µ–ª–∞—é—â–∏–π –≥–ª—É–±–æ–∫–∏–µ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ –æ –º–∏—Å—Å–∏–∏ –¥—É—à–∏ –∏ –ø—É—Ç–∏ —Ä–∞–∑–≤–∏—Ç–∏—è. "
            "–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å —Ä–∞–∑–≤—ë—Ä–Ω—É—Ç—ã–π –∞–Ω–∞–ª–∏–∑ –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è —á–µ–ª–æ–≤–µ–∫–∞, –µ–≥–æ –≤—ã—Å—à–∏—Ö —Ü–µ–ª–µ–π –∏ –∫–∞—Ä–º–∏—á–µ—Å–∫–∏—Ö –∑–∞–¥–∞—á.\n\n"
            "üìå –§–æ—Ä–º–∞—Ç –∏ —Å—Ç–∏–ª—å:\n"
            "- –ü–∏—à–∏ –≤–¥–æ—Ö–Ω–æ–≤–ª—è—é—â–µ, —Ñ–∏–ª–æ—Å–æ—Ñ—Å–∫–∏ –∏ –≥–ª—É–±–æ–∫–æ, –Ω–æ —è—Å–Ω–æ –∏ –¥–æ—Å—Ç—É–ø–Ω–æ.\n"
            "- –ò—Å–ø–æ–ª—å–∑—É–π —Ç–µ—Ä–º–∏–Ω—ã –≤–µ–¥–∏—á–µ—Å–∫–æ–π –∞—Å—Ç—Ä–æ–ª–æ–≥–∏–∏ (–†–∞—Ö—É, –ö–µ—Ç—É, 9-–π –¥–æ–º, 12-–π –¥–æ–º, –∫–∞—Ä–∞–∫–∏ –∏ —Ç.–¥.), –æ–±—ä—è—Å–Ω—è—è –∏—Ö –ø—Ä–æ—Å—Ç—ã–º–∏ —Å–ª–æ–≤–∞–º–∏.\n"
            "- –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä—É–π —Ç–µ–∫—Å—Ç –∫–∞–∫ —Ü–µ–ª–æ—Å—Ç–Ω—ã–π –ø—É—Ç—å —Ä–∞–∑–≤–∏—Ç–∏—è –¥—É—à–∏.\n"
            "- –≠–º–æ–¥–∑–∏ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å, –Ω–æ –Ω–µ –±–æ–ª—å—à–µ 1‚Äì2 –Ω–∞ —Ä–∞–∑–¥–µ–ª.\n"
            "- –ó–∞–≤–µ—Ä—à–∏ –∫–∞–∂–¥—É—é —á–∞—Å—Ç—å –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–º–∏ —Å–æ–≤–µ—Ç–∞–º–∏ –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º–∏ –¥–ª—è —Ä–∞—Å–∫—Ä—ã—Ç–∏—è –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª–∞.\n"
            "- –ü–æ–¥—á—ë—Ä–∫–∏–≤–∞–π —Å–≤–æ–±–æ–¥—É –≤—ã–±–æ—Ä–∞ –∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —Ä–æ—Å—Ç–∞.\n\n"
            "üìä –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç–≤–µ—Ç–∞ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —Å–æ–±–ª—é–¥–∞–π):\n"
            "1. –ü—É—Ç—å –¥—É—à–∏ ‚Äî –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –∑–∞–¥–∞—á–∏ –∏ —Å–º—ã—Å–ª –≤–æ–ø–ª–æ—â–µ–Ω–∏—è.\n"
            "2. –ì–ª–∞–≤–Ω—ã–µ –¥–∞—Ä—ã –∏ —Ç–∞–ª–∞–Ω—Ç—ã ‚Äî –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª, —Å –∫–æ—Ç–æ—Ä—ã–º —á–µ–ª–æ–≤–µ–∫ –ø—Ä–∏—à—ë–ª –≤ —ç—Ç–æ—Ç –º–∏—Ä.\n"
            "3. –ö–∞—Ä–º–∏—á–µ—Å–∫–∏–µ —É—Ä–æ–∫–∏ ‚Äî –∑–∞–¥–∞—á–∏, –∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–µ–¥—Å—Ç–æ–∏—Ç –ø—Ä–æ–π—Ç–∏ –¥–ª—è —Ä–æ—Å—Ç–∞.\n"
            "4. –í–µ–∫—Ç–æ—Ä—ã —Ä–∞–∑–≤–∏—Ç–∏—è ‚Äî –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è, –∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–∏–≤–µ–¥—É—Ç –∫ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –º–∏—Å—Å–∏–∏.\n"
            "5. –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —à–∞–≥–∏ ‚Äî –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è, –ø—Ä–∞–∫—Ç–∏–∫–∏, –º–∞–Ω—Ç—Ä—ã, —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏.\n"
            "6. –ò—Ç–æ–≥ ‚Äî —Ü–µ–ª–æ—Å—Ç–Ω—ã–π –≤—ã–≤–æ–¥ –æ –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–∏–∏ –∏ –ø—É—Ç–∏ —Ä–∞–∑–≤–∏—Ç–∏—è.\n\n"
            "üìú –ò—Å—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:\n"
            f"{birth_text}\n\n"
            f"–°—Ñ–µ—Ä–∞ –∞–Ω–∞–ª–∏–∑–∞: {sphere_text}\n"
            f"–ü–æ–¥—Ç–µ–º–∞: {sub_text}\n\n"
            "–ó–∞–¥–∞—á–∞: –°—Ñ–æ—Ä–º–∏—Ä—É–π —Ñ–∏–ª–æ—Å–æ—Ñ—Å–∫–∏–π –∏ –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞–∑–±–æ—Ä –æ–±—ä—ë–º–æ–º –Ω–µ –º–µ–Ω–µ–µ 3000 —Å–∏–º–≤–æ–ª–æ–≤. "
            "–¢–µ–∫—Å—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∫–∞–∫ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è –ø–æ –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–∏—é: –≥–ª—É–±–æ–∫–∏–π, –≤–¥–æ—Ö–Ω–æ–≤–ª—è—é—â–∏–π –∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏—á–µ—Å–∫–∏–π."
        )

    else:
        # –ù–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π ‚Äî –¥–µ—Ñ–æ–ª—Ç
        prompt = (
            f"–°—Ñ–æ—Ä–º–∏—Ä—É–π —Ä–∞–∑–≤—ë—Ä–Ω—É—Ç—ã–π –∞–Ω–∞–ª–∏–∑ –ø–æ —Å—Ñ–µ—Ä–µ: {sphere_text} / {sub_text}.\n"
            f"–î–∞–Ω–Ω—ã–µ: {birth_text}\n"
            "–û–±—ä—ë–º 3000+ —Å–∏–º–≤–æ–ª–æ–≤, —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–æ, —Å –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–º–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º–∏."
        )

    # -----------------------
    # üì° GPT-–∑–∞–ø—Ä–æ—Å
    # -----------------------
    try:
    completion = client.chat.completions.create(
        model="gpt-4o",
        messages=[
            {"role": "system", "content": "–¢—ã –æ–ø—ã—Ç–Ω—ã–π –≤–µ–¥–∏—á–µ—Å–∫–∏–π –∞—Å—Ç—Ä–æ–ª–æ–≥-–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç."},
            {"role": "user", "content": prompt},
        ]
    )

    raw_answer = completion.choices[0].message.content
    answer = format_answer(raw_answer)

    # üîß –†–∞–∑–±–∏–≤–∞–µ–º –¥–ª–∏–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –Ω–∞ —á–∞—Å—Ç–∏
    MAX_LEN = 4000
    for i in range(0, len(answer), MAX_LEN):
        part = answer[i:i + MAX_LEN]
        await message.answer(part)

    # üíæ –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–ª–Ω—ã–π –æ—Ç–≤–µ—Ç
    save_reading(uid, sphere, sub, prompt, answer)

    if not u.get("paid") and not u.get("free_used"):
        update_user(uid, free_used=1)
        await message.answer(
            "üîí –¢—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∞ –±–µ—Å–ø–ª–∞—Ç–Ω—É—é –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é. "
            "–ß—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å –≤—Å–µ —Ä–∞–∑–¥–µ–ª—ã ‚Äî –≤–≤–µ–¥–∏ —Å–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–æ–¥ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏."
        )
    
    except OpenAIError:
    log.exception("OpenAI error")
    await message.answer("‚ö†Ô∏è –°–µ–π—á–∞—Å –ò–ò –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –î–∞–≤–∞–π –ø–æ–ø—Ä–æ–±—É–µ–º –ø–æ–∑–∂–µ.")
    except Exception:
    log.exception("Unexpected error")
    await message.answer("‚ùå –ß—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫. –ü–æ–ø—Ä–æ–±—É–µ–º –µ—â—ë —Ä–∞–∑.")

# ----------------------
# Webhook lifecycle
# ----------------------
async def on_startup(dp):
    db_init()  # ‚úÖ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö, –µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—à—å –µ—ë
    await bot.set_webhook(WEBHOOK_URL, drop_pending_updates=True)
    log.info(f"‚úÖ Webhook —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: {WEBHOOK_URL}")

async def on_shutdown(dp):
    await bot.delete_webhook()
    log.info("üßπ Webhook —É–¥–∞–ª—ë–Ω (–±–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω)")


if __name__ == "__main__":
    # Render / Railway webhook runner
    start_webhook(
        dispatcher=dp,
        webhook_path=WEBHOOK_PATH,
        on_startup=on_startup,
        on_shutdown=on_shutdown,
        skip_updates=True,
        host=WEBAPP_HOST,
        port=WEBAPP_PORT,
    )
